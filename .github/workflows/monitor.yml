name: Telegram Monitor

on:
  # å®šæ—¶è§¦å‘ï¼šåŒ—äº¬æ—¶é—´ 09:00-23:55 æ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  # Cron ä½¿ç”¨ UTC æ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´ = UTC + 8
  # åŒ—äº¬æ—¶é—´ 09:00 = UTC 01:00
  # åŒ—äº¬æ—¶é—´ 23:55 = UTC 15:55
  # æ¯ 5 åˆ†é’Ÿï¼š0,5,10,15,20,25,30,35,40,45,50,55 åˆ†
  schedule:
    - cron: '0,5,10,15,20,25,30,35,40,45,50,55 1-15 * * *'  # UTC 01:00-15:55 æ¯ 5 åˆ†é’Ÿ
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šé˜²æ­¢å¤šä¸ªä»»åŠ¡åŒæ—¶è¿è¡Œå¯¼è‡´ last_id.txt å†²çª
concurrency:
  group: monitor-group  # æ‰€æœ‰ä»»åŠ¡å±äºåŒä¸€ç»„
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œæ–°ä»»åŠ¡æ’é˜Ÿç­‰å¾…

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    # è¶…æ—¶ç†”æ–­ï¼šå•æ¬¡è¿è¡Œä¸åº”è¶…è¿‡ 3 åˆ†é’Ÿï¼ˆæ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰
    # å¦‚æœè¶…æ—¶ï¼Œå¼ºåˆ¶æ€æ­»ä»»åŠ¡ï¼Œè®©æ’é˜Ÿçš„æ–°ä»»åŠ¡æ¥ç®¡
    timeout-minutes: 3
    
    # è®¾ç½®æƒé™ï¼šå…è®¸å†™å…¥ä»“åº“å†…å®¹ï¼ˆç”¨äºæäº¤ last_id.txtï¼‰
    permissions:
      contents: write
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä»¥ä¾¿ git commit
      
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–
      
      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. è¿è¡Œç›‘æ§è„šæœ¬
      - name: ğŸš€ Run Telegram monitor
        env:
          # ä» GitHub Secrets è¯»å–æ•æ„Ÿé…ç½®
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          STRING_SESSION: ${{ secrets.STRING_SESSION }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          # å…³é”®ï¼šç¦ç”¨ Python è¾“å‡ºç¼“å†²ï¼Œç¡®ä¿æ—¥å¿—å®æ—¶æ˜¾ç¤ºåœ¨ Actions æ§åˆ¶å°
          # å¦åˆ™æ—¥å¿—ä¼šåœ¨è„šæœ¬ç»“æŸåæ‰ä¸€æ¬¡æ€§è¾“å‡ºï¼Œæ— æ³•å®æ—¶ç›‘æ§è¿è¡ŒçŠ¶æ€
          PYTHONUNBUFFERED: 1
        run: |
          python main.py
      
      # 5. æäº¤æ›´æ–°çš„ last_id.txt
      - name: ğŸ’¾ Commit last_id.txt
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update last_id.txt [skip ci]"
          file_pattern: 'last_id.txt'
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'
          # å¦‚æœæ²¡æœ‰å˜æ›´åˆ™è·³è¿‡æäº¤
          skip_dirty_check: false
